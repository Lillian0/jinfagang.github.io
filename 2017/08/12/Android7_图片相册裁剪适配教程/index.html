<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Jintian">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Android7 图片相册裁剪适配教程"/>
  <meta property="og:description" content="Just my blog" />
  <meta property="og:site_name" content="Jin Tian"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.comundefined"/>
  
    <link rel="alternate" href="/atom.xml" title="Jin Tian" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Jin Tian</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.dark.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/girl.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Android7 图片相册裁剪适配教程</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="/about">
                  
                  About
                  
                </a>
              </li>
            
              <li>
                <a href="/tags">
                  
                  Tag
                  
                </a>
              </li>
            
              <li>
                <a href="/achievements">
                  
                  Achievements
                  
                </a>
              </li>
            
              <li>
                <a href="/resume">
                  
                  Resume
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/jinfagang">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:jinfagang19@163.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Jintian</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-08-12</span>
            <span class="time">14:10:30</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/默认分类/">默认分类</a>
</span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>本文介绍 Android7 图片相册裁剪适配教程<br><a id="more"></a></p>
<h1 id="Android7-图片相册裁剪适配教程"><a href="#Android7-图片相册裁剪适配教程" class="headerlink" title="Android7 图片相册裁剪适配教程"></a>Android7 图片相册裁剪适配教程</h1><blockquote>
<p>本文由在当地较为英俊的男子金天大神原创，版权所有，欢迎转载，但请保留这段版权信息，多谢合作，有任何疑问欢迎通过微信联系我交流：<code>jintianiloveu</code></p>
</blockquote>
<h2 id="Android7-适配问题"><a href="#Android7-适配问题" class="headerlink" title="Android7 适配问题"></a>Android7 适配问题</h2><p>ok, 新博客的第一篇比较正式的笔记。闲话不多说，本篇博客记录Android7，图片剪切适配的蛋疼问题。首先大家必须要明白，在安卓7中，图片不在是那么操作的了，文件不再是那么简单的操作了，多了一个FileProvider的东西，在以前我们从相册获取一张图片并裁剪可能非常简单和随意：</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">chooseAvatar</span><span class="params">()</span> </span>&#123;</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI);</div><div class="line">    intent.setType(<span class="string">"image/*"</span>);</div><div class="line">    startActivityForResult(intent, CODE_PHOTO);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class="line">    <span class="keyword">switch</span> (requestCode)&#123;</div><div class="line">        <span class="keyword">case</span> CODE_CANCEL:</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"取消了相册选择"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        <span class="keyword">case</span> CODE_PHOTO:</div><div class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">                Uri uri = data.getData();</div><div class="line">                DebugHelper.LogMessage(<span class="string">"step 2, start zoom image"</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">                startPhotoZoom(uri);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> CODE_RESULT:&#123;</div><div class="line">            Uri inputUri = FileProvider.getUriForFile(getActivity(), <span class="string">"com.ouman.luoliluoli.fileprovider"</span>, mCropFile);</div><div class="line">            Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                bitmap = BitmapFactory.decodeStream(getActivity().getContentResolver().openInputStream(inputUri));</div><div class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            DebugHelper.LogMessage(<span class="string">"step 4, get result and set cropped image."</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">            avatar.setImageBitmap(bitmap);</div><div class="line">            avatarImageFile = mCropFile;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startPhotoZoom</span><span class="params">(Uri inputUri)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (inputUri == <span class="keyword">null</span>) &#123;</div><div class="line">        Log.e(<span class="string">"error"</span>,<span class="string">"The uri is not exist."</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</div><div class="line">    Uri outPutUri = Uri.fromFile(mCropFile);</div><div class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">        <span class="comment">//这个方法是处理4.4以上图片返回的Uri对象不同的处理方法</span></div><div class="line">        String url = FileHelper.getRealPathFromURI(getActivity(), inputUri);</div><div class="line">        intent.setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(url)), <span class="string">"image/*"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        intent.setDataAndType(inputUri, <span class="string">"image/*"</span>);</div><div class="line">    &#125;</div><div class="line">    intent.putExtra(MediaStore.EXTRA_OUTPUT, outPutUri);</div><div class="line">    intent.putExtra(<span class="string">"crop"</span>, <span class="string">"true"</span>);</div><div class="line">    <span class="comment">// aspectX aspectY 是宽高的比例</span></div><div class="line">    intent.putExtra(<span class="string">"aspectX"</span>, <span class="number">1</span>);</div><div class="line">    intent.putExtra(<span class="string">"aspectY"</span>, <span class="number">1</span>);</div><div class="line">    <span class="comment">// outputX outputY 是裁剪图片宽高</span></div><div class="line">    intent.putExtra(<span class="string">"outputX"</span>, <span class="number">250</span>);</div><div class="line">    intent.putExtra(<span class="string">"outputY"</span>, <span class="number">250</span>);</div><div class="line">    intent.putExtra(<span class="string">"return-data"</span>, <span class="keyword">false</span>);</div><div class="line">    intent.putExtra(<span class="string">"noFaceDetection"</span>, <span class="keyword">false</span>);</div><div class="line">    intent.putExtra(<span class="string">"outputFormat"</span>, <span class="string">"JPEG"</span>);</div><div class="line">    DebugHelper.LogMessage(<span class="string">"step 3, start return result back"</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">    startActivityForResult(intent, CODE_RESULT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我这里并没有修改适配后的代码，总之，在FileProvider之前，获取图片并裁剪比较简单。在android7以后问题也没有变复杂，只不过是不能直接从File中获取Uri，从而无法ContentResolver去获取二进制的数据。那么如何才能去适配呢？</p>
<h2 id="要修改的地方并不多"><a href="#要修改的地方并不多" class="headerlink" title="要修改的地方并不多"></a>要修改的地方并不多</h2><p>其实要适配Android7 要修改的地方并不多，甚至说只需要几行代码即可。我看网上很多人说要修改manifest，要修改xml中的file_path.xml，我测试了其实完全没有必要。当然为了保险起见，我们还是在manifest中添加一下权限：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 适配android7 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">provider</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">"android.support.v4.content.FileProvider"</span></div><div class="line">            <span class="attr">android:authorities</span>=<span class="string">"com.ouman.luoliluoli.fileprovider"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"false"</span></div><div class="line">            <span class="attr">android:grantUriPermissions</span>=<span class="string">"true"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></div><div class="line">                <span class="attr">android:name</span>=<span class="string">"android.support.FILE_PROVIDER_PATHS"</span></div><div class="line">                <span class="attr">android:resource</span>=<span class="string">"@xml/file_paths"</span> /&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里的 <code>com.ouman.luoliluoli.fileprovider</code>可以修改成你的。任何名字都可以，不过一半是包名加provider来命名。最后，我们需要处理的地方加上 <strong>FileProvider.getUriForFile(getActivity(), “com.ouman.luoliluoli.fileprovider”, mCropFile);</strong> 这个方法，来从File获取Uri。</p>
<p>我总结了一个代码如下：<br><figure class="highlight aspectj"><table><tr><td class="code"><pre><div class="line"><span class="comment">// variables we need for Android7 image crop</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_PHOTO = <span class="number">1115</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_RESULT = <span class="number">1118</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODE_CANCEL = <span class="number">5556</span>;</div><div class="line">   String path = Environment.getExternalStorageDirectory()+<span class="string">"/images/"</span>;</div><div class="line">   File mCameraFile = <span class="keyword">new</span> File(path, <span class="string">"photo.jpg"</span>);<span class="comment">//照相机的File对象</span></div><div class="line">   File mCropFile = <span class="keyword">new</span> File(path, <span class="string">"avatar.jpg"</span>);<span class="comment">//裁剪后的File对象</span></div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Basic steps for setting avatar with crop image</div><div class="line">    * Step 1: Start a intent for PHOTO, this step should be different in android7</div><div class="line">    * Step 2: onActivityResult received photo request, start zoom image</div><div class="line">    * Step 3: in startZoomImage it will using gallery to crop image, and then send result code</div><div class="line">    * Step 4: in onActivityResult method received the cropped image and set it.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">chooseAvatar</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// check parent dir is exist or not</span></div><div class="line">       <span class="keyword">if</span> (!mCameraFile.getParentFile().exists()) &#123;</div><div class="line">           mCameraFile.getParentFile().mkdirs();</div><div class="line">       &#125;</div><div class="line">       Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI);</div><div class="line">       intent.setType(<span class="string">"image/*"</span>);</div><div class="line">       startActivityForResult(intent, CODE_PHOTO);</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">       <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">       <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class="line">       <span class="keyword">switch</span> (requestCode)&#123;</div><div class="line">           <span class="keyword">case</span> CODE_CANCEL:</div><div class="line">               Toast.makeText(getActivity(), <span class="string">"取消了相册选择"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">           <span class="keyword">case</span> CODE_PHOTO:</div><div class="line">               <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">                   Uri uri = data.getData();</div><div class="line">                   DebugHelper.LogMessage(<span class="string">"step 2, start zoom image"</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">                   startPhotoZoom(uri);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> CODE_RESULT:&#123;</div><div class="line">               Uri inputUri = FileProvider.getUriForFile(getActivity(), <span class="string">"com.ouman.luoliluoli.fileprovider"</span>, mCropFile);</div><div class="line">               Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   bitmap = BitmapFactory.decodeStream(getActivity().getContentResolver().openInputStream(inputUri));</div><div class="line">               &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">                   e.printStackTrace();</div><div class="line">               &#125;</div><div class="line">               DebugHelper.LogMessage(<span class="string">"step 4, get result and set cropped image."</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">               avatar.setImageBitmap(bitmap);</div><div class="line">               avatarImageFile = mCropFile;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startPhotoZoom</span><span class="params">(Uri inputUri)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (inputUri == <span class="keyword">null</span>) &#123;</div><div class="line">           Log.e(<span class="string">"error"</span>,<span class="string">"The uri is not exist."</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</div><div class="line">       <span class="comment">//sdk&gt;=24</span></div><div class="line">       <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</div><div class="line"></div><div class="line">           Uri outPutUri = Uri.fromFile(mCropFile);</div><div class="line">           intent.setDataAndType(inputUri, <span class="string">"image/*"</span>);</div><div class="line">           intent.putExtra(MediaStore.EXTRA_OUTPUT, outPutUri);</div><div class="line">           intent.addFlags(FLAG_GRANT_READ_URI_PERMISSION);</div><div class="line">           intent.addFlags(FLAG_GRANT_WRITE_URI_PERMISSION);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           Uri outPutUri = Uri.fromFile(mCropFile);</div><div class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">               <span class="comment">//这个方法是处理4.4以上图片返回的Uri对象不同的处理方法</span></div><div class="line">               String url = FileHelper.getRealPathFromURI(getActivity(), inputUri);</div><div class="line">               intent.setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(url)), <span class="string">"image/*"</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               intent.setDataAndType(inputUri, <span class="string">"image/*"</span>);</div><div class="line">           &#125;</div><div class="line">           intent.putExtra(MediaStore.EXTRA_OUTPUT, outPutUri);</div><div class="line">       &#125;</div><div class="line">       intent.putExtra(<span class="string">"crop"</span>, <span class="string">"true"</span>);</div><div class="line">       <span class="comment">// aspectX aspectY 是宽高的比例</span></div><div class="line">       intent.putExtra(<span class="string">"aspectX"</span>, <span class="number">1</span>);</div><div class="line">       intent.putExtra(<span class="string">"aspectY"</span>, <span class="number">1</span>);</div><div class="line">       <span class="comment">// outputX outputY 是裁剪图片宽高</span></div><div class="line">       intent.putExtra(<span class="string">"outputX"</span>, <span class="number">250</span>);</div><div class="line">       intent.putExtra(<span class="string">"outputY"</span>, <span class="number">250</span>);</div><div class="line">       intent.putExtra(<span class="string">"return-data"</span>, <span class="keyword">false</span>);</div><div class="line">       intent.putExtra(<span class="string">"noFaceDetection"</span>, <span class="keyword">false</span>);</div><div class="line">       intent.putExtra(<span class="string">"outputFormat"</span>, <span class="string">"JPEG"</span>);</div><div class="line">       DebugHelper.LogMessage(<span class="string">"step 3, start return result back"</span>, <span class="string">"crop and choose photo"</span>);</div><div class="line">       startActivityForResult(intent, CODE_RESULT);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>上述代码，变量加载类里面，几乎不需要修改其他方法，只需要在onActivityResult里面的RESULT CODE里面获取到图片，执行你的逻辑即可。</p>
<h2 id="下期预告"><a href="#下期预告" class="headerlink" title="下期预告"></a>下期预告</h2><p>本次老司机列车到此结束，如果大家对本文由任何疑问，欢迎通过渠道联系我。下一篇我们将release 萝莉萝莉第二版本！！</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Copyright <a target="_blank" href="https://github.com/jinfagang">Jintian</a>
          An Intelligent Scientist
          </p>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">DeepX</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

